<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:skia="clr-namespace:SkiaSharp.Views.Maui.Controls;assembly=SkiaSharp.Views.Maui.Controls"
             x:Class="VE.Views.MainPage"
             x:Name="MainPageRoot"
             Title="Visual Editor">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <!-- Panel narzędzi -->
            <ColumnDefinition Width="220"/>
            <!-- Panel opcji narzędzi -->
            <ColumnDefinition Width="*"/>
            <!-- Canvas -->
            <ColumnDefinition Width="300"/>
            <!-- Warstwy -->
        </Grid.ColumnDefinitions>

        <!-- Toolbar -->
        <HorizontalStackLayout Grid.Row="0" Grid.ColumnSpan="4"
            Padding="4"
            Spacing="8"
            BackgroundColor="#23262B"
            HeightRequest="48">
            <Button Text="Nowy"
                    Command="{Binding NewProjectCommand}"
                    TextColor="White"
                    BackgroundColor="#393e46"
                    FontAttributes="Bold"
                    CornerRadius="6"/>
            <Button Text="Otwórz"
                    TextColor="White"
                    BackgroundColor="#393e46"
                    FontAttributes="Bold"
                    CornerRadius="6"
                    Command="{Binding OpenImageCommand}"/>
            <Button Text="Zapisz"
                    TextColor="White"
                    BackgroundColor="#393e46"
                    FontAttributes="Bold"
                    CornerRadius="6"
                    Clicked="SaveButton_Clicked"/>
        </HorizontalStackLayout>

        <!-- Lewy panel narzędzi rysowania -->
        <StackLayout Grid.Row="1" Grid.Column="0" BackgroundColor="#424242" Padding="18">
            <Label Text="Narzędzia"
                   FontAttributes="Bold"
                   FontSize="18"
                   Margin="10,0,10,6"
                   TextColor="White"/>

            <!-- Przyciski narzędzi -->
            <Button Text="Pędzel"
                    Command="{Binding ToolButtonClickedCommand}"
                    CommandParameter="Brush"/>
            <Button Text="Gumka"
                    Command="{Binding ToolButtonClickedCommand}"
                    CommandParameter="Eraser"/>
            <Button Text="Wiadro"
                    Command="{Binding ToolButtonClickedCommand}"
                    CommandParameter="Bucket"/>
            <Button Text="Pipeta"
                    Command="{Binding ToolButtonClickedCommand}"
                    CommandParameter="Pipette"/>
        </StackLayout>

        <!-- Panel opcji narzędzi -->
        <StackLayout Grid.Row="1" Grid.Column="1" BackgroundColor="#626262" Padding="10">
            <!-- Dynamiczna zawartość -->
            <Label Text="{Binding SelectedTool}" FontAttributes="Bold" FontSize="16" Margin="0,0,0,8" TextColor="White"/>

            <!-- Dynamiczne opcje zależne od SelectedTool -->
            <ContentView>
                <ContentView.Triggers>
                    <DataTrigger TargetType="ContentView" Binding="{Binding SelectedTool}" Value="Brush">
                        <Setter Property="Content">
                            <Setter.Value>
                                <StackLayout Spacing="8">
                                    <Label Text="Kolor pędzla (RGB):"
                                           FontAttributes="Bold"
                                           TextColor="#23262B"/>
                                    <HorizontalStackLayout Spacing="4">
                                        <Entry Text="{Binding Brush.R, Mode=TwoWay}" WidthRequest="40" MaxLength="3" Keyboard="Numeric" Placeholder="R"/>
                                        <Entry Text="{Binding Brush.G, Mode=TwoWay}" WidthRequest="40" MaxLength="3" Keyboard="Numeric" Placeholder="G"/>
                                        <Entry Text="{Binding Brush.B, Mode=TwoWay}" WidthRequest="40" MaxLength="3" Keyboard="Numeric" Placeholder="B"/>
                                    </HorizontalStackLayout>

                                    <!-- SUWAKI RGB -->
                                    <Label Text="Suwaki koloru:" FontAttributes="Bold" Margin="0,6,0,3" TextColor="#23262B"/>
                                    <StackLayout Spacing="6">
                                        <Border 
                                            Stroke="#939393" 
                                            StrokeThickness="1" 
                                            Background="#f2f2f2" 
                                            StrokeShape="RoundRectangle 10">
                                            <Label 
                                                Text="Czerwony (R)" 
                                                FontSize="13" 
                                                TextColor="Red" 
                                                BackgroundColor="LightGray" 
                                                Padding="2,2,2,2"
                                            />
                                        </Border>
                                        <Slider 
                                            Minimum="0" 
                                            Maximum="255" 
                                            Value="{Binding Brush.R, Mode=TwoWay}" 
                                            MinimumTrackColor="#c0392b" 
                                            MaximumTrackColor="#eee"
                                        />

                                        <Border 
                                            Stroke="#939393" 
                                            StrokeThickness="1" 
                                            Background="#f2f2f2" 
                                            StrokeShape="RoundRectangle 10">
                                            <Label 
                                                Text="Zielony (G)" 
                                                FontSize="13" 
                                                TextColor="Green" 
                                                BackgroundColor="LightGray" 
                                                Padding="2,2,2,2"
                                            />
                                        </Border>
                                        <Slider 
                                            Minimum="0" 
                                            Maximum="255" 
                                            Value="{Binding Brush.G, Mode=TwoWay}" 
                                            MinimumTrackColor="#27ae60" 
                                            MaximumTrackColor="#eee"
                                        />

                                        <Border 
                                            Stroke="#939393" 
                                            StrokeThickness="1" 
                                            Background="#f2f2f2" 
                                            StrokeShape="RoundRectangle 10">
                                            <Label 
                                                Text="Niebieski (B)" 
                                                FontSize="13" 
                                                TextColor="Blue" 
                                                BackgroundColor="LightGray" 
                                                Padding="2,2,2,2"
                                            />
                                        </Border>
                                        <Slider 
                                            Minimum="0" 
                                            Maximum="255" 
                                            Value="{Binding Brush.B, Mode=TwoWay}" 
                                            MinimumTrackColor="#2980b9" 
                                            MaximumTrackColor="#eee"
                                        />
                                    </StackLayout>
                                    
                                    <!-- Grid gotowych kolorów -->
                                    <Label Text="Paleta kolorów:" FontAttributes="Bold" Margin="0,4,0,2" TextColor="#23262B"/>

                                    <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto" RowDefinitions="Auto,Auto">
                                        <BoxView BackgroundColor="#FF0000" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#FF0000"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#00FF00" Grid.Column="1" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#00FF00"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#0000FF" Grid.Column="2" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#0000FF"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#FFFF00" Grid.Column="3" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#FFFF00"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#FF00FF" Grid.Column="4" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#FF00FF"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>

                                        <BoxView BackgroundColor="#00FFFF" Grid.Row="1" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#00FFFF"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#808080" Grid.Row="1" Grid.Column="1" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#808080"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#FFFFFF" Grid.Row="1" Grid.Column="2" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#FFFFFF"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#000000" Grid.Row="1" Grid.Column="3" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#000000"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#C0C0C0" Grid.Row="1" Grid.Column="4" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#C0C0C0"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                    </Grid>

                                    <Label Text="Podgląd koloru:" FontSize="13" Margin="0,9,0,2" TextColor="#23262B"/>
                                    <Frame Padding="0"
                                           HeightRequest="36"
                                           WidthRequest="68"
                                           CornerRadius="7"
                                           BorderColor="#393e46"
                                           HasShadow="False"
                                           VerticalOptions="Start">
                                        <BoxView Color="{Binding BrushColor}"
                                                 WidthRequest="60"
                                                 HeightRequest="28"
                                                 CornerRadius="6"
                                                 VerticalOptions="Center"/>
                                    </Frame>
                                </StackLayout>
                            </Setter.Value>
                        </Setter>
                    </DataTrigger>

                    <DataTrigger TargetType="ContentView" Binding="{Binding SelectedTool}" Value="Eraser">
                        <Setter Property="Content">
                            <Setter.Value>
                                <StackLayout Spacing="8">
                                    <Label Text="Opcje gumki:"
                       FontAttributes="Bold"
                       TextColor="#23262B"/>
                                    <Slider Minimum="2"
                        Maximum="40"
                        Value="{Binding Eraser.Size, Mode=TwoWay}" />
                                    <Label Text="{Binding Eraser.Size, StringFormat='Rozmiar: {0}'}" FontSize="13"/>
                                </StackLayout>
                            </Setter.Value>
                        </Setter>
                    </DataTrigger>
                </ContentView.Triggers>
            </ContentView>
        </StackLayout>

        <!-- Główny Canvas -->
        <Label Grid.Row="1" Grid.Column="2" Text="{Binding ImageLoadError}" TextColor="Red" FontSize="13"/>
        <ScrollView Grid.Row="1" Grid.Column="2" Orientation="Both" BackgroundColor="Transparent">
            <Frame Margin="10"
                   BackgroundColor="White"
                   BorderColor="#AAAAAA"
                   CornerRadius="4"
                   WidthRequest="700"
                   HeightRequest="450"
                   HorizontalOptions="Center"
                   VerticalOptions="Center">
                <skia:SKCanvasView x:Name="MainCanvas"
                                  PaintSurface="MainCanvas_PaintSurface"
                                  EnableTouchEvents="True"
                                  Touch="MainCanvas_Touch"
                                  WidthRequest="700"
                                  HeightRequest="450"/>
            </Frame>
        </ScrollView>

        <!-- Panel warstw -->
        <StackLayout Grid.Row="1" Grid.Column="3" BackgroundColor="#525252" Padding="8">
            <Label Text="Warstwy" FontAttributes="Bold" TextColor="White"/>
            <CollectionView ItemsSource="{Binding Layers}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame
                            Padding="0"
                            Margin="0,6,0,0"
                            BackgroundColor="{Binding IsSelected, Converter={StaticResource IsSelectedToColorConverter}}"
                            BorderColor="#23262B"
                            HasShadow="False"
                            CornerRadius="9"
                            HeightRequest="52"
                        >
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding BindingContext.SelectLayerCommand, Source={x:Reference MainPageRoot}}" CommandParameter="{Binding .}" />
                            </Frame.GestureRecognizers>
                            <Grid ColumnDefinitions="90,38,48" Padding="10" VerticalOptions="CenterAndExpand">
                                <Label Text="{Binding Name}" Grid.Column="0" TextColor="White" FontAttributes="Bold" FontSize="16"/>
                                <Button
                                    Grid.Column="1"
                                    Text="{Binding IsVisible, Converter={StaticResource BoolToEyeIconConverter}}"
                                    Command="{Binding BindingContext.ToggleLayerVisibilityCommand, Source={x:Reference MainPageRoot}}"
                                    CommandParameter="{Binding .}"
                                    FontFamily="Segoe UI Emoji"
                                    FontSize="19"
                                    WidthRequest="38"
                                    HeightRequest="38"
                                    BackgroundColor="#393E46"
                                    TextColor="White"
                                    CornerRadius="6"
                                    Padding="0"
                                />
                                <Button
                                    Grid.Column="2"
                                    Text="Usuń"
                                    TextColor="White"
                                    FontSize="15"
                                    BackgroundColor="#393E46"
                                    Command="{Binding BindingContext.RemoveLayerCommand, Source={x:Reference MainPageRoot}}"
                                    CommandParameter="{Binding .}" 
                                    WidthRequest="48"
                                    HeightRequest="38"
                                    IsEnabled="{Binding Name, Converter={StaticResource BackgroundDeleteBlockerConverter}}"
                                    CornerRadius="6"
                                    Padding="0"
                                />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <Button 
                Text="Dodaj warstwę" 
                Margin="0,10,0,0"
                Command="{Binding AddLayerCommand}"
                BackgroundColor="#393E46"
                TextColor="White"
                FontAttributes="Bold"
                CornerRadius="6"
                HeightRequest="50"
                FontSize="17"
            />
        </StackLayout>
    </Grid>
</ContentPage>
