<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:skia="clr-namespace:SkiaSharp.Views.Maui.Controls;assembly=SkiaSharp.Views.Maui.Controls"
             x:Class="VE.Views.MainPage"
             x:Name="MainPageRoot"
             Title="Visual Editor">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <!-- Panel narzędzi -->
            <ColumnDefinition Width="Auto"/>
            <!-- Panel opcji narzędzi -->
            <ColumnDefinition Width="220"/>
            <!-- Canvas -->
            <ColumnDefinition Width="*"/>
            <!-- Warstwy -->
            <ColumnDefinition Width="300"/>
        </Grid.ColumnDefinitions>

        <!-- Toolbar -->
        <HorizontalStackLayout Grid.Row="0" Grid.ColumnSpan="4"
            Padding="4"
            Spacing="8"
            BackgroundColor="#23262B"
            HeightRequest="48">
            <Button Text="Nowy"
                    Command="{Binding NewProjectCommand}"
                    TextColor="White"
                    BackgroundColor="#393e46"
                    FontAttributes="Bold"
                    CornerRadius="6"/>
            <Button Text="Otwórz"
                    TextColor="White"
                    BackgroundColor="#393e46"
                    FontAttributes="Bold"
                    CornerRadius="6"
                    Command="{Binding OpenImageCommand}"/>
            <Button Text="Zapisz"
                    TextColor="White"
                    BackgroundColor="#393e46"
                    FontAttributes="Bold"
                    CornerRadius="6"
                    Clicked="SaveButton_Clicked"/>
        </HorizontalStackLayout>

        <!-- Lewy panel narzędzi rysowania -->
        <StackLayout Grid.Row="1" Grid.Column="0" BackgroundColor="#424242" Padding="18">
            <Label Text="Narzędzia"
                   FontAttributes="Bold"
                   FontSize="18"
                   Margin="10,0,10,6"
                   TextColor="White"/>

            <!-- Przyciski narzędzi -->
            <Button Text="Pędzel"
                    Command="{Binding ToolButtonClickedCommand}"
                    CommandParameter="Brush"/>
            <Button Text="Gumka"
                    Command="{Binding ToolButtonClickedCommand}"
                    CommandParameter="Eraser"/>
            <Button Text="Wiadro"
                    Command="{Binding ToolButtonClickedCommand}"
                    CommandParameter="Bucket"/>
            <Button Text="Pipeta"
                    Command="{Binding ToolButtonClickedCommand}"
                    CommandParameter="Pipette"/>
        </StackLayout>

        <!-- Panel opcji narzędzi -->
        <StackLayout Grid.Row="1" Grid.Column="1" BackgroundColor="#626262" Padding="10">
            <!-- Dynamiczna zawartość -->
            <Label Text="{Binding SelectedTool}" FontAttributes="Bold" FontSize="16" Margin="0,0,0,8" TextColor="White"/>

            <!-- Dynamiczne opcje zależne od SelectedTool -->
            <ContentView>
                <ContentView.Triggers>
                    <DataTrigger TargetType="ContentView" Binding="{Binding SelectedTool}" Value="Brush">
                        <Setter Property="Content">
                            <Setter.Value>
                                <StackLayout Spacing="8">
                                    <Label Text="Kolor pędzla (RGB):"
                                           FontAttributes="Bold"
                                           TextColor="#23262B"/>
                                    <HorizontalStackLayout Spacing="4">
                                        <Entry Text="{Binding Brush.R, Mode=TwoWay}" WidthRequest="40" MaxLength="3" Keyboard="Numeric" Placeholder="R"/>
                                        <Entry Text="{Binding Brush.G, Mode=TwoWay}" WidthRequest="40" MaxLength="3" Keyboard="Numeric" Placeholder="G"/>
                                        <Entry Text="{Binding Brush.B, Mode=TwoWay}" WidthRequest="40" MaxLength="3" Keyboard="Numeric" Placeholder="B"/>
                                    </HorizontalStackLayout>

                                    <!-- Wybór końcówki -->
                                    <Picker
                                        Title="Typ pędzla"
                                        ItemsSource="{Binding BrushTipTypes}" 
                                        SelectedItem="{Binding Brush.TipType, Mode=TwoWay}">
                                    </Picker>

                                    <!-- Ustawienia wielkości pędzla -->
                                    <StackLayout x:Name="BrushSizePanel" Spacing="6">
                                        <StackLayout.Triggers>
                                            <DataTrigger 
                                                TargetType="StackLayout"
                                                Binding="{Binding Brush.TipType}" 
                                                Value="Spray">
                                                <Setter Property="IsVisible" Value="True"/>
                                            </DataTrigger>
                                            <DataTrigger 
                                                TargetType="StackLayout"
                                                Binding="{Binding Brush.TipType}" 
                                                Value="Marker">
                                                <Setter Property="IsVisible" Value="True"/>
                                            </DataTrigger>
                                            <DataTrigger 
                                                TargetType="StackLayout"
                                                Binding="{Binding Brush.TipType}" 
                                                Value="Brush">
                                                <Setter Property="IsVisible" Value="True"/>
                                            </DataTrigger>
                                            <DataTrigger 
                                                TargetType="StackLayout"
                                                Binding="{Binding Brush.TipType}" 
                                                Value="Pencil">
                                                <Setter Property="IsVisible" Value="True"/>
                                            </DataTrigger>
                                        </StackLayout.Triggers>
                                        <Label 
                                            Text="{Binding Brush.TipType, StringFormat='Rozmiar końcówki ({0}):'}"
                                            FontSize="13" 
                                            TextColor="#23262B"/>
                                        <Slider 
                                            Minimum="2" 
                                            Maximum="40" 
                                            Value="{Binding Brush.Size, Mode=TwoWay}" />
                                        <Label 
                                            Text="{Binding Brush.Size, StringFormat='Aktualny rozmiar: {0}'}" 
                                            FontSize="13"/>
                                    </StackLayout>
                                    
                                    <!-- Ustawienie gęstości spray -->
                                    <StackLayout x:Name="SprayDensityPanel" Spacing="6">
                                        <StackLayout.Triggers>
                                            <DataTrigger 
                                                TargetType="StackLayout"
                                                Binding="{Binding Brush.TipType}" 
                                                Value="Spray">
                                                <Setter Property="IsVisible" Value="True"/>
                                            </DataTrigger>
                                        </StackLayout.Triggers>
                                        <Label 
                                            Text="Gęstość spray:" 
                                            FontSize="13"/>
                                        <Slider 
                                            Minimum="5" 
                                            Maximum="40" 
                                            Value="{Binding Brush.SprayDensity, Mode=TwoWay}" />
                                        <Label 
                                            Text="{Binding Brush.SprayDensity, StringFormat='Aktualna gęstość: {0}'}" 
                                            FontSize="13"/>
                                    </StackLayout>

                                    <!-- SUWAKI RGB -->
                                    <Label Text="Suwaki koloru:" FontAttributes="Bold" Margin="0,6,0,3" TextColor="#23262B"/>
                                    <StackLayout Spacing="6">
                                        <Border 
                                            Stroke="#939393" 
                                            StrokeThickness="1" 
                                            Background="#f2f2f2" 
                                            StrokeShape="RoundRectangle 10">
                                            <Label 
                                                Text="Czerwony (R)" 
                                                FontSize="13" 
                                                TextColor="Red" 
                                                BackgroundColor="LightGray" 
                                                Padding="2,2,2,2"
                                            />
                                        </Border>
                                        <Slider 
                                            Minimum="0" 
                                            Maximum="255" 
                                            Value="{Binding Brush.R, Mode=TwoWay}" 
                                            MinimumTrackColor="#c0392b" 
                                            MaximumTrackColor="#eee"
                                        />

                                        <Border 
                                            Stroke="#939393" 
                                            StrokeThickness="1" 
                                            Background="#f2f2f2" 
                                            StrokeShape="RoundRectangle 10">
                                            <Label 
                                                Text="Zielony (G)" 
                                                FontSize="13" 
                                                TextColor="Green" 
                                                BackgroundColor="LightGray" 
                                                Padding="2,2,2,2"
                                            />
                                        </Border>
                                        <Slider 
                                            Minimum="0" 
                                            Maximum="255" 
                                            Value="{Binding Brush.G, Mode=TwoWay}" 
                                            MinimumTrackColor="#27ae60" 
                                            MaximumTrackColor="#eee"
                                        />

                                        <Border 
                                            Stroke="#939393" 
                                            StrokeThickness="1" 
                                            Background="#f2f2f2" 
                                            StrokeShape="RoundRectangle 10">
                                            <Label 
                                                Text="Niebieski (B)" 
                                                FontSize="13" 
                                                TextColor="Blue" 
                                                BackgroundColor="LightGray" 
                                                Padding="2,2,2,2"
                                            />
                                        </Border>
                                        <Slider 
                                            Minimum="0" 
                                            Maximum="255" 
                                            Value="{Binding Brush.B, Mode=TwoWay}" 
                                            MinimumTrackColor="#2980b9" 
                                            MaximumTrackColor="#eee"
                                        />
                                    </StackLayout>
                                    
                                    <!-- Grid gotowych kolorów -->
                                    <Label Text="Paleta kolorów:" FontAttributes="Bold" Margin="0,4,0,2" TextColor="#23262B"/>

                                    <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,Auto" RowDefinitions="Auto,Auto">
                                        <BoxView BackgroundColor="#FF0000" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#FF0000"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#00FF00" Grid.Column="1" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#00FF00"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#0000FF" Grid.Column="2" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#0000FF"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#FFFF00" Grid.Column="3" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#FFFF00"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#FF00FF" Grid.Column="4" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#FF00FF"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>

                                        <BoxView BackgroundColor="#00FFFF" Grid.Row="1" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#00FFFF"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#808080" Grid.Row="1" Grid.Column="1" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#808080"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#FFFFFF" Grid.Row="1" Grid.Column="2" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#FFFFFF"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#000000" Grid.Row="1" Grid.Column="3" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#000000"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                        <BoxView BackgroundColor="#C0C0C0" Grid.Row="1" Grid.Column="4" WidthRequest="32" HeightRequest="32" Margin="2">
                                            <BoxView.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding SetColorCommand}" CommandParameter="#C0C0C0"/>
                                            </BoxView.GestureRecognizers>
                                        </BoxView>
                                    </Grid>

                                    <Label Text="Podgląd koloru:" FontSize="13" Margin="0,9,0,2" TextColor="#23262B"/>
                                    <Frame Padding="0"
                                           HeightRequest="36"
                                           WidthRequest="68"
                                           CornerRadius="7"
                                           BorderColor="#393e46"
                                           HasShadow="False"
                                           VerticalOptions="Start">
                                        <BoxView Color="{Binding BrushColor}"
                                                 WidthRequest="60"
                                                 HeightRequest="28"
                                                 CornerRadius="6"
                                                 VerticalOptions="Center"/>
                                    </Frame>
                                </StackLayout>
                            </Setter.Value>
                        </Setter>
                    </DataTrigger>

                    <!-- Gumka -->
                    <DataTrigger TargetType="ContentView" Binding="{Binding SelectedTool}" Value="Eraser">
                        <Setter Property="Content">
                            <Setter.Value>
                                <StackLayout Spacing="8">
                                    <Label Text="Opcje gumki:"
                       FontAttributes="Bold"
                       TextColor="#23262B"/>
                                    <Slider Minimum="2"
                        Maximum="40"
                        Value="{Binding Eraser.Size, Mode=TwoWay}" />
                                    <Label Text="{Binding Eraser.Size, StringFormat='Rozmiar: {0}'}" FontSize="13"/>
                                </StackLayout>
                            </Setter.Value>
                        </Setter>
                    </DataTrigger>
                    
                    <!-- Wiadro -->
                    <DataTrigger TargetType="ContentView" Binding="{Binding SelectedTool}" Value="Bucket">
                        <Setter Property="Content">
                            <Setter.Value>
                                <StackLayout Spacing="10">
                                    <Label Text="Wiadro - wybór koloru:"/>
                                    <CollectionView ItemsSource="{Binding BucketSettings.PredefinedColors}" SelectionMode="Single" SelectedItem="{Binding BucketSettings.SelectedColor}">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <BoxView Color="{Binding .}" WidthRequest="40" HeightRequest="40">
                                                    <BoxView.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding Path=BindingContext.SetBucketColorCommand, Source={x:Reference MainPageRoot}}" CommandParameter="{Binding .}" />
                                                    </BoxView.GestureRecognizers>
                                                </BoxView>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>

                                    <Label Text="Ustaw kolor ręcznie (RGB):"/>
                                    <Slider Minimum="0" Maximum="255" Value="{Binding BucketSettings.Red, Mode=TwoWay}" />
                                    <Slider Minimum="0" Maximum="255" Value="{Binding BucketSettings.Green, Mode=TwoWay}" />
                                    <Slider Minimum="0" Maximum="255" Value="{Binding BucketSettings.Blue, Mode=TwoWay}" />
                                    <BoxView Color="{Binding BucketSettings.SelectedColor}" WidthRequest="80" HeightRequest="40" />
                                </StackLayout>
                            </Setter.Value>
                        </Setter>
                    </DataTrigger>
                </ContentView.Triggers>
            </ContentView>
        </StackLayout>

        <!-- Główny Canvas -->
        <Label Grid.Row="1" Grid.Column="2" Text="{Binding ImageLoadError}" TextColor="Red" FontSize="13"/>
        <skia:SKCanvasView 
            Grid.Row="1"
            Grid.Column="2"
            x:Name="MainCanvas"
            PaintSurface="MainCanvas_PaintSurface"
            EnableTouchEvents="True"
            Touch="MainCanvas_Touch"
            VerticalOptions="Fill"
            HorizontalOptions="Fill"
        />
        <!-- Panel warstw -->
        <StackLayout Grid.Row="1" Grid.Column="3" BackgroundColor="#525252" Padding="8" Spacing="8">

            <Label Text="Warstwy" FontAttributes="Bold" TextColor="White" FontSize="15"/>

            <!-- ScrollView na warstwy (przewija gdy jest dużo warstw) -->
            <ScrollView Orientation="Vertical" HeightRequest="280">
                <CollectionView ItemsSource="{Binding Layers}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame
                                Padding="0"
                                Margin="0,3,0,0"
                                BackgroundColor="{Binding IsSelected, Converter={StaticResource IsSelectedToColorConverter}}"
                                BorderColor="#23262B"
                                HasShadow="False"
                                CornerRadius="6"
                                HeightRequest="34"
                            >
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding BindingContext.SelectLayerCommand, Source={x:Reference MainPageRoot}}" CommandParameter="{Binding .}" />
                                </Frame.GestureRecognizers>
                                <Grid ColumnDefinitions="70,32,32" Padding="7" VerticalOptions="Center">
                                    <Label Text="{Binding Name}" Grid.Column="0" TextColor="White" FontAttributes="Bold" FontSize="13"/>
                                    <Button
                                        Grid.Column="1"
                                        Text="{Binding IsVisible, Converter={StaticResource BoolToEyeIconConverter}}"
                                        Command="{Binding BindingContext.ToggleLayerVisibilityCommand, Source={x:Reference MainPageRoot}}"
                                        CommandParameter="{Binding .}"
                                        FontSize="13"
                                        WidthRequest="28"
                                        HeightRequest="28"
                                        BackgroundColor="#393E46"
                                        TextColor="White"
                                        CornerRadius="4"
                                        Padding="0"
                                    />
                                    <Button
                                        Grid.Column="2"
                                        Text="Usuń"
                                        TextColor="White"
                                        FontSize="12"
                                        BackgroundColor="#393E46"
                                        Command="{Binding BindingContext.RemoveLayerCommand, Source={x:Reference MainPageRoot}}"
                                        CommandParameter="{Binding .}" 
                                        WidthRequest="34"
                                        HeightRequest="28"
                                        IsEnabled="{Binding Name, Converter={StaticResource BackgroundDeleteBlockerConverter}}"
                                        CornerRadius="4"
                                        Padding="0"
                                    />
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </ScrollView>

            <Button 
                Text="Dodaj warstwę" 
                Margin="0,6,0,0"
                Command="{Binding AddLayerCommand}"
                BackgroundColor="#393E46"
                TextColor="White"
                FontAttributes="Bold"
                CornerRadius="5"
                HeightRequest="36"
                FontSize="13"
            />

            <!-- Panel do zmiany rozmiaru canvasu -->
            <Grid ColumnDefinitions="Auto,Auto,Auto,Auto" Margin="0,12,0,0" VerticalOptions="Center">
                <Label Text="Szer:" Grid.Column="0" TextColor="White" FontSize="12" VerticalOptions="Center"/>
                <Entry Text="{Binding PendingCanvasWidth, Mode=TwoWay}" Grid.Column="1" WidthRequest="46" FontSize="12" HorizontalTextAlignment="Center" Keyboard="Numeric"/>
                <Label Text="Wys:" Grid.Column="2" TextColor="White" FontSize="12" VerticalOptions="Center"/>
                <Entry Text="{Binding PendingCanvasHeight, Mode=TwoWay}" Grid.Column="3" WidthRequest="46" FontSize="12" HorizontalTextAlignment="Center" Keyboard="Numeric"/>
            </Grid>
            <Button 
                Text="Zmień rozmiar"
                Command="{Binding ResizeCanvasCommand}"
                Margin="0,6,0,0"
                BackgroundColor="#393E46"
                TextColor="White"
                CornerRadius="5"
                HeightRequest="28"
                FontSize="12"
            />

        </StackLayout>
    </Grid>
</ContentPage>
